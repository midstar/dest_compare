<html>

<!--------------------------------------------------------------------------->
<head>
<title>Sweski</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>

<style>

/****************************************************************************/
/* TAB style */

/* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Special for the settings TAB */
#tab-settings {
    float: right;
    font-size: 27px;
    padding: 2px 16px 5px;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tab class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tab-page {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
}

/****************************************************************************/
/* Table style */

#tab-table-page table {
    border-collapse: collapse;
    table-layout: fixed;
    word-wrap: break-word;
    text-align: left;
    width: 100%;
    margin-left: 5px;
    margin-right: 5px;
    font-size: 12px;
}

#tab-table-page tr:nth-child(even) {
    background-color: lightblue;
}

/****************************************************************************/
/* Map style */

#map {
    height: 100%;
}

/****************************************************************************/
/* Settings style */

.settings-title {
    font-weight: bold;
    margin-top: 5px;
    margin-bottom: 5px;
    font-size: 20px;
}

#settings-location-lat, #settings-location-lon {
    width: 180px;
}



</style>

<script>

// Defined in same order as presented in the table
keys = [
    "name",
    "altitude",
    "vertical_drop",
    "piste_count",
    "piste_count@green",
    "piste_count@blue",
    "piste_count@red",
    "piste_count@black",
    "piste_longest",
    "lift_count",
    "lift_count@chair",
    "lift_count@surface",
    "lift_count@gondola",
    "distance" // Will be calculated
];

// Swedish language
lang_swe = {
    // Part 1 - Localization of database keys
    "name" : "Namn",
    "altitude" : "Höjd över havet",
    "vertical_drop" : "Fallhöjd",
    "piste_count" : "Antal nedfarter",
    "piste_count@green" : "Antal gröna nedfarter",
    "piste_count@blue" : "Antal blå nedfarter",
    "piste_count@red" : "Antal röda nedfarter",
    "piste_count@black" : "Antal svarta nedfarter",
    "piste_longest" : "Längsta nedfart",
    "lift_count" : "Antal liftar",
    "lift_count@chair" : "Antal stolsliftar",
    "lift_count@surface" : "Antal släpliftar",
    "lift_count@gondola" : "Antal berg, kabin eller gondolliftar",
    "distance" : "Avstånd (km)",

    // Part 2 - Localication of HTML tags (based on ID)
    "html-tag-id" : {
        "tab-table" : "Tabell",
        "tab-map" : "Karta",
        "tab-plot" : "Diagram",
        "settings-location-title" : "Min plats",
        "settings-location-lat-label" : "Latitud",
        "settings-location-lon-label" : "Longitud",
        "settings-location-fetch" : "Hämta min position"
    }
};

// Name must be unique, will be used as key in references
database = [
    {
        "name" : "Stöten",
        "altitude" : 948,
        "vertical_drop" : 370,
        "piste_count" : 47,
        "piste_count@green" : 27,
        "piste_count@blue" : 11,
        "piste_count@red" : 4,
        "piste_count@black" : 5,
        "piste_longest" : 3060,
        "lift_count" : 21,
        "lift_count@chair" : 2,
        "lift_count@surface" : 19,
        "lift_count@gondola" : 0,
        "latitude" : 61.274824447454634, 
        "longitude" : 12.898966698853474
    },
    {
        "name" : "Björnrike",
        "altitude" : 950,
        "vertical_drop" : 470,
        "piste_count" : 16,
        "piste_count@green" : 4,
        "piste_count@blue" : 4,
        "piste_count@red" : 6,
        "piste_count@black" : 3,
        "piste_longest" : 2100,
        "lift_count" : 12,
        "lift_count@chair" : 1,
        "lift_count@surface" : 11,
        "lift_count@gondola" : 0,
        "latitude" : 62.4228664877963, 
        "longitude" : 13.957621303714978
    },
    {
        "name" : "Romme Alpin",
        "altitude" : 407,
        "vertical_drop" : 275,
        "piste_count" : 33,
        "piste_count@green" : 9,
        "piste_count@blue" : 11,
        "piste_count@red" : 3,
        "piste_count@black" : 33,
        "piste_longest" : 2700,
        "lift_count" : 13,
        "lift_count@chair" : 5,
        "lift_count@surface" : 8,
        "lift_count@gondola" : 0,
        "latitude" : 60.39364522001965, 
        "longitude" : 15.382514100529649
    },
    {
        "name" : "Åre",
        "altitude" : 1274,
        "vertical_drop" : 890,
        "piste_count" : 89,
        "piste_count@green" : 15,
        "piste_count@blue" : 39,
        "piste_count@red" : 31,
        "piste_count@black" : 4,
        "piste_longest" : 6500,
        "lift_count" : 41,
        "lift_count@chair" : 7,
        "lift_count@surface" : 30,
        "lift_count@gondola" : 4,
        "latitude" : 63.40590905840682, 
        "longitude" : 13.077881958996054
    },
    {
        "name" : "Idre Fjäll",
        "altitude" : 890,
        "vertical_drop" : 307,
        "piste_count" : 41,
        "piste_count@green" : 16,
        "piste_count@blue" : 10,
        "piste_count@red" : 5,
        "piste_count@black" : 10,
        "piste_longest" : 2800,
        "lift_count" : 24,
        "lift_count@chair" : 4,
        "lift_count@surface" : 16,
        "lift_count@gondola" : 0,
        "latitude" : 61.8905057807043, 
        "longitude" : 12.832153473844823
    }
    /* Template
    {
        "name" : "",
        "altitude" : ,
        "vertical_drop" : ,
        "piste_count" : ,
        "piste_count@green" : ,
        "piste_count@blue" : ,
        "piste_count@red" : ,
        "piste_count@black" : ,
        "piste_longest" : ,
        "lift_count" : ,
        "lift_count@chair" : ,
        "lift_count@surface" : ,
        "lift_count@gondola" : ,
        "latitude" : , 
        "longitude" : 
    }
    */
];

config = {
    "lang" : lang_swe,
    "latitude" : 59.41152274059428, 
    "longitude" : 17.81181064711004,
    "map-zoom" : 5.5,
    "tab_selected" : "tab-table",
    "table_selected" : "name",
    "table_ascending" : true
};



//////////////////////////////////////////////////////////////////////////////
// Misc

window.onload = function() {
    configSetup();

    localize();

    tabSetup(config["tab_selected"]);

    databasePreprocess();

    updateTable(config["table_selected"], config["table_ascending"]);

    mapSetup();

    settingsSetup();
};

// Update localization for HTML tags
function localize() {
    for (var id in config["lang"]["html-tag-id"])
        document.getElementById(id).innerHTML = config["lang"]["html-tag-id"][id];
}

// Calculate distance between two coordinates using the
// haversine formula. Returns distance in km.
function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // metres
    var φ1 = lat1 * Math.PI/180; // φ, λ in radians
    var φ2 = lat2 * Math.PI/180;
    var Δφ = (lat2-lat1) * Math.PI/180;
    var Δλ = (lon2-lon1) * Math.PI/180;

    var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    var d = R * c; // in metres

    return Math.round(d / 1000);
}

// Adds keys in the database that are calculated
function databasePreprocess() {
    for (var i = 0; i < database.length ; i++) {
        elem = database[i];

        // Calculated distance from "home"
        elem["distance"] = calcDist(
            elem["latitude"],   elem["longitude"],
            config["latitude"], config["longitude"]);
    }    
}


//////////////////////////////////////////////////////////////////////////////
// TAB page general handling

function tabSetup(defaultTabPageId) {
    tabShow(defaultTabPageId);

    tabButtons = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tabButtons.length ; i++) {
        tabButton = tabButtons[i];
        tabButton.setAttribute("onclick", "tabShow(\"" + tabButton.id + "\")");
    }
}

function tabShow(tabId) {
    // Show the correct tab
    tabPages = document.getElementsByClassName("tab-page");
    for (var i = 0 ; i < tabPages.length ; i++) {
        tabPage = tabPages[i];
        if(tabPage.id == tabId + "-page")
            tabPage.style.display = "block";
        else
            tabPage.style.display = "none";
    }

    // Mark the active button
    tabButtons = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tabButtons.length ; i++) {
        tabButton = tabButtons[i];
        if (tabButton.id == tabId)
            tabButton.className += " active";
        else 
            tabButton.className = tabButton.className.replace(" active", "");
    }

    // Remeber the selected tab
    configSetSelectedTab(tabId);
} 

//////////////////////////////////////////////////////////////////////////////
// Table page

function updateTable(selected, ascending) {
    configSetTableSelSort(selected, ascending);

    var table = document.getElementById("table");

    // Delete old elements
    table.innerHTML = "";

    // Generate titles (th)
    var row_head = document.createElement("tr");
    for (var i = 0 ; i < keys.length ; i++) {
        var cell_head = document.createElement("th");
        var symbol = "";
        var clickAscending = "true";
        if (keys[i] == selected) {
            if (ascending) {
                symbol = " &#8595;";
                clickAscending = "false";
            } else {
                symbol = " &#8593;";
            }
        }
        cell_head.setAttribute("onclick", "updateTable(\"" + keys[i] + "\", " + clickAscending + ")");
        cell_head.innerHTML = config["lang"][keys[i]] + symbol;
        row_head.appendChild(cell_head);
    }
    table.appendChild(row_head);

    // Sort database
    database.sort(function(a, b) {
        var aBeforeB = true;
        if (ascending)
            aBeforeB = a[selected] < b[selected];
        else
            aBeforeB = a[selected] > b[selected];
        if (aBeforeB)
            return -1;
        return 1;
    });

    // Generate data (td)
    for (var i = 0; i < database.length ; i++) {
        elem = database[i];
        var row = document.createElement("tr");
        for (var j = 0 ; j < keys.length ; j++) {
            var cell = document.createElement("td");
            cell.innerHTML = elem[keys[j]];
            row.appendChild(cell);
        }
        table.appendChild(row);
    }
} 

//////////////////////////////////////////////////////////////////////////////
// Map page

function mapSetup() {
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
            source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([config["longitude"], config["latitude"]]),
            zoom: config["map-zoom"]
        })
    });

    var layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [
                new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([config["longitude"], config["latitude"]]))
                })
            ]
        })/*,
        style: new ol.style.Style({
            fillColor: "#008000",
            strokeColor: "#000000",
            strokeWidth: 2
        })*/
    });
    map.addLayer(layer);
}

//////////////////////////////////////////////////////////////////////////////
// Settings page

function settingsSetup() {
    var elemLat = document.getElementById("settings-location-lat");
    var elemLon = document.getElementById("settings-location-lon");

    elemLat.value = config["latitude"];
    elemLon.value = config["longitude"];

    if (!navigator.geolocation) {
        document.getElementById("settings-location-fetch").disabled = true;
    }

}

// Adjusts according to input min and max (handled as float)
function adjustInputNumber(inputId) {
    var elemInput = document.getElementById(inputId);
    var value = parseFloat(elemInput.value);
    if (value < elemInput.min || value > elemInput.max || isNaN(value))
        elemInput.value = 0;
    else
        elemInput.value = value;
    return elemInput.value;
}

function updateLatLon() {
    const lat = adjustInputNumber("settings-location-lat");
    const lon = adjustInputNumber("settings-location-lon");
    configSetLatLon(lat, lon);
}

function fetchLatLon() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            document.getElementById("settings-location-lat").value = pos.coords.latitude;
            document.getElementById("settings-location-lon").value = pos.coords.longitude;
            updateLatLon();
        });
    }
}

//////////////////////////////////////////////////////////////////////////////
// Configuration handling - URL search parameters

// Overides default configuration based on URL search parameters
function configSetup() {
    const params = new URLSearchParams(window.location.search);

    // Latitude / Longitude
    if (params.has("lat") && params.has("lon")) {
        config["latitude"] = parseFloat(params.get("lat"));
        config["longitude"] = parseFloat(params.get("lon"));
    } else 
        fetchLatLon();
    
    // Selected tab
    if (params.has("tab_selected"))
        config["tab_selected"] = params.get("tab_selected");

    // Table selected 
    if (params.has("table_selected"))
        config["table_selected"] = params.get("table_selected");

    // Table sort 
    if (params.has("table_ascending"))
        config["table_ascending"] = params.get("table_ascending") == "true";

}

// Will reload page
function configSetLatLon(lat, lon) {
    const params = new URLSearchParams(window.location.search);
    params.set("lat", lat);
    params.set("lon", lon);
    window.location.search = params.toString(); // Will reload page
}

function configSetSelectedTab(selectedTab) {
    const params = new URLSearchParams(window.location.search);
    params.set("tab_selected", selectedTab);
    // Replace history
    history.replaceState({},selectedTab,"?" + params.toString());
}

function configSetTableSelSort(selected, ascending) {
    const params = new URLSearchParams(window.location.search);
    params.set("table_selected", selected);
    params.set("table_ascending", ascending);
    // Replace history
    history.replaceState({},selected+ascending,"?" + params.toString());    
}







</script>

</head>

<!--------------------------------------------------------------------------->
<body>

    <div class="tab">
        <button class="tab-button" id="tab-table">Table</button>
        <button class="tab-button" id="tab-map">Map</button>
        <button class="tab-button" id="tab-plot">Plot</button>
        <button class="tab-button" id="tab-settings">&#9881;</button>
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Table TAB -->
    <div class="tab-page" id="tab-table-page">
        <table id="table"></table>
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Map TAB -->
    <div class="tab-page" id="tab-map-page">
        <div id="map" class="map"></div>
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Plot TAB -->
    <div class="tab-page" id="tab-plot-page">
        Plot will show up here
    </div>

    <!----------------------------------------------------------------------------------->
    <!-- Settings TAB -->
    <div class="tab-page" id="tab-settings-page">
        <div class="settings-group">
            <div class="settings-title" id="settings-location-title">My location</div>
            <table>
                <tr>
                    <td id="settings-location-lat-label">Latitude</td>
                    <td><input type="number" min="-90" max="90" id="settings-location-lat" onchange="updateLatLon()"></input></td>
                </tr>
                <tr>
                    <td id="settings-location-lon-label">Longitude</td>
                    <td><input type="number" min="-180" max="180" id="settings-location-lon" onchange="updateLatLon()"></input></td>
                </tr>
            <table>
            <button id="settings-location-fetch" onclick="fetchLatLon()">Fetch my position</button>
        </div>
    </div>

</body>

</html>